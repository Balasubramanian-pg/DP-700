# Protecting Sensitive Data with Dynamic Data Masking (DDM)

In any data warehouse, protecting sensitive information is paramount. **Dynamic Data Masking (DDM)** is a powerful security feature in Microsoft Fabric that helps you prevent unauthorized access to sensitive data by obscuring it on the fly for non-privileged users.

DDM allows you to define masking rules at the column level. When a user queries a table, the masking policy is applied in real-time to the query results, hiding the original data without ever changing the data stored in the database.

<div align="center">
<svg width="400" height="120" viewBox="0 0 400 120" fill="none" xmlns="http://www.w3.org/2000/svg">
<!-- Data Source -->
<ellipse cx="60" cy="85" rx="40" ry="15" fill="#E3F2FD" stroke="#1E88E5" stroke-width="2"/>
<path d="M20 65 C 20 50, 100 50, 100 65 V 85 C 100 100, 20 100, 20 85 Z" fill="#E3F2FD" stroke="#1E88E5" stroke-width="2"/>
<text x="60" y="45" font-family="Segoe UI, sans-serif" font-size="12" text-anchor="middle">Stored Data</text>
<text x="60" y="75" font-family="Segoe UI, sans-serif" font-size="10" font-weight="bold" text-anchor="middle">123-456-7890</text>
<!-- Arrow and Mask -->
<path d="M105 65 H 175" stroke="#78909C" stroke-width="2" stroke-dasharray="4 2"/>
<path d="M170 60 L 180 65 L 170 70" stroke="#78909C" stroke-width="2" fill="none"/>
<path d="M140 30 L 120 50 L 140 70 L 160 50 Z" fill="#FFF3E0" stroke="#EF6C00" stroke-width="2.5" opacity="0.9"/>
<path d="M128 50 L 152 50" stroke="#EF6C00" stroke-width="3" stroke-linecap="round"/>
<text x="140" y="20" font-family="Segoe UI, sans-serif" font-size="12" text-anchor="middle">DDM Policy</text>
<!-- Masked Result -->
<rect x="185" y="50" width="180" height="30" rx="4" fill="#FCE4EC" stroke="#AD1457" stroke-width="2"/>
<text x="275" y="35" font-family="Segoe UI, sans-serif" font-size="12" text-anchor="middle">Masked Query Result</text>
<text x="275" y="70" font-family="Segoe UI, sans-serif" font-size="10" font-weight="bold" text-anchor="middle">XXX-XXX-7890</text>
</svg>
</div>

### Why Use Dynamic Data Masking? Key Benefits

DDM provides several critical advantages for securing your data warehouse.

| Benefit | Description |
| :--- | :--- |
| **Real-Time Masking** | Masking is applied dynamically as queries are executed. The actual data is never exposed in the results for unauthorized users, providing robust, real-time protection. |
| **Simple Implementation**| You can apply masking with simple T-SQL commands. No complex coding or application-level changes are required, making it accessible to all skill levels. |
| **Data Integrity is Preserved** | The data in the database is never physically changed. Masking rules only affect the query results, ensuring the underlying data remains intact, complete, and secure. |

### How It Works: Defining a Masking Rule

DDM is configured at the column level using one of four built-in masking functions.

| Masking Type | Description & Use Case | Visual Example | Function Syntax |
| :--- | :--- | :--- | :--- |
| **Default** | Provides full masking based on the column's data type. A `0` for numbers, an empty string for text, or a default date. Use it to completely hide data. | `12345` → `0` | `default()` |
| **Email** | Exposes the first letter and the constant suffix `.com`, masking the rest. Ideal for confirming a field contains an email without revealing the address. | `user@fabric.com` → `u****@c.com` | `email()` |
| **Custom Text** | Exposes the first `n` and last `n` characters, with a custom padding string in the middle. Perfect for partially hiding sensitive identifiers. | `123-456-7890` → `XXX-XXX-7890` | `partial(prefix, padding, suffix)` |
| **Random** | Replaces any numeric value with a random number within a specified range. Useful for creating statistically representative but anonymized datasets. | `99.50` → `(random 1-100)` | `random(low, high)` |

> [!NOTE]
> The parameters for `partial()` define the number of unmasked characters at the start (`prefix`), the masking string (`padding`), and the number of unmasked characters at the end (`suffix`).

### Putting It into Practice: Configuration Example

Let's consider a `Customers` table in your warehouse with sensitive information. We want to protect the `Email`, `PhoneNumber`, and `CreditCardNumber` columns.

To apply the masking rules, you would run the following T-SQL commands one time:

```transact-sql
-- Mask the Email column to show only the first letter
ALTER TABLE Customers
ALTER COLUMN Email ADD MASKED WITH (FUNCTION = 'email()');

-- Mask the PhoneNumber to show only the last 4 digits
ALTER TABLE Customers
ALTER COLUMN PhoneNumber ADD MASKED WITH (FUNCTION = 'partial(0, "XXX-XXX-", 4)');

-- Mask the CreditCardNumber to show only the last 4 digits
ALTER TABLE Customers
ALTER COLUMN CreditCardNumber ADD MASKED WITH (FUNCTION = 'partial(0, "XXXX-XXXX-XXXX-", 4)');
```

> [!TIP]
> This is a one-time setup. Once the masking is applied to the table schema, it is automatically enforced for all non-privileged users across all queries, with no need to modify existing applications or reports.

### Viewing the Masked Results: The User Experience

The effect of DDM is based on the user's privileges.

#### **Query Result for a Privileged User (e.g., Admin)**
A user with `UNMASK` permissions will see the data in its original, unaltered form.
```
CustomerName:     John Doe
Email:            johndoe@contoso.com
PhoneNumber:      123-456-7890
CreditCardNumber: 1234-5678-9012-3456
```

#### **Query Result for a Nonprivileged User**
The same query run by a user without `UNMASK` permissions will return the masked data.
```
CustomerName:     John Doe
Email:            j****@c.com
PhoneNumber:      XXX-XXX-7890
CreditCardNumber: XXXX-XXXX-XXXX-3456
```
As you can see, the sensitive data is automatically hidden, enhancing security while still providing context.

> [!IMPORTANT]
> ### Security Considerations
> DDM is a powerful feature, but it's essential to understand its role in your overall security strategy.
>
> -   **Obfuscation, Not Encryption:** DDM obscures data in query results; it does not encrypt the data at rest. The underlying data is not physically changed.
> -   **Potential for Inference:** Determined users with direct query permissions could potentially infer the actual data through repeated queries. For example, they could run `WHERE CreditCardNumber LIKE '1234-5678-9012-345%'` to test different values.
> -   **A Layered Approach:** DDM should be used as part of a comprehensive data security strategy that includes proper object-level security (SQL granular permissions) and adherence to the principle of least privilege.
